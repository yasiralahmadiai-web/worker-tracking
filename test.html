<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 0;
      color: #333;
    }

    .page {
      max-width: 480px;
      margin: 0 auto;
      padding: 20px 15px 40px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 20px;
    }

    .logo-box {
      flex: 1;
      text-align: center;
    }

    .logo-box img {
      max-width: 100%;
      max-height: 60px;
      object-fit: contain;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }

    h1 {
      font-size: 22px;
      margin: 0 0 10px;
      text-align: center;
      color: #006c5f;
    }

    .welcome {
      text-align: center;
      margin-bottom: 20px;
      font-size: 14px;
      color: #555;
    }

    .role-grid {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .role {
      flex: 1;
      border-radius: 10px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      border: 2px solid transparent;
      transition: 0.2s;
      background: #f8fafc;
    }

    .role:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .role.selected {
      border-color: #00897b;
      background: #e0f4f1;
    }

    .role-icon {
      font-size: 26px;
      margin-bottom: 6px;
    }

    .role-title {
      font-weight: bold;
      margin-bottom: 3px;
    }

    .role-sub {
      font-size: 11px;
      color: #666;
    }

    label {
      display: block;
      margin-top: 10px;
      font-size: 13px;
    }

    input {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      margin-top: 5px;
      border-radius: 8px;
      border: 1px solid #ccd3df;
      font-size: 14px;
    }

    input[readonly] {
      background: #f1f3f6;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 18px;
    }

    button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: none;
      font-size: 15px;
      cursor: pointer;
    }

    #btnStart {
      background: #00897b;
      color: #fff;
    }

    #btnStop {
      background: #e53935;
      color: #fff;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status-box {
      margin-top: 12px;
      font-size: 13px;
      padding: 10px;
      border-radius: 8px;
      background: #f1f3f6;
      color: #444;
    }

    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-right: 5px;
      background: #eceff1;
    }

    .status-start { background: #c8e6c9; }
    .status-running { background: #fff9c4; }
    .status-end { background: #ffcdd2; }

    .small {
      font-size: 11px;
      color: #777;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<div class="page">

  <!-- Ø§Ù„Ø´Ø¹Ø§Ø±Ø§Øª -->
  <div class="header">
    <div class="logo-box">
      <!-- Ø¶Ø¹ Ù…Ù„Ù Ø´Ø¹Ø§Ø± Ø£Ù…Ø§Ù†Ø© Ø¬Ø¯Ø© Ø¨Ø§Ø³Ù… jeddah-logo.png Ø¨Ø¬Ø§Ù†Ø¨ Ù…Ù„Ù HTML -->
      <img src="jeddah-logo.png" alt="Ø£Ù…Ø§Ù†Ø© Ø¬Ø¯Ø©">
    </div>
    <div class="logo-box">
      <!-- Ø¶Ø¹ Ù…Ù„Ù Ø´Ø¹Ø§Ø± Applus Ø¨Ø§Ø³Ù… applus-logo.png Ø¨Ø¬Ø§Ù†Ø¨ Ù…Ù„Ù HTML -->
      <img src="applus-logo.png" alt="Applus">
    </div>
  </div>

  <div class="card">
    <h1>Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h1>
    <div class="welcome">
      Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹<br>
      Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø¹Ù…Ù„ÙƒØŒ Ø«Ù… Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø© Ù„ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…ÙˆÙ‚Ø¹Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„.
    </div>

    <!-- Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¸Ù -->
    <div class="role-grid">
      <div class="role" id="roleDriver" data-type="driver">
        <div class="role-icon">ğŸš›</div>
        <div class="role-title">Ø³Ø§Ø¦Ù‚</div>
        <div class="role-sub">Driver</div>
      </div>
      <div class="role" id="roleCleaner" data-type="cleaner">
        <div class="role-icon">ğŸ§¹</div>
        <div class="role-title">Ø¹Ø§Ù…Ù„ Ù†Ø¸Ø§ÙØ©</div>
        <div class="role-sub">Cleaner</div>
      </div>
    </div>

    <!-- Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
    <div id="formSection" style="display:none;">

      <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù</label>
      <input type="number" id="employeeId" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù">

      <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</label>
      <input type="text" id="employeeName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù">

      <div id="truckField" style="display:none;">
        <label>Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø­Ù†Ø©</label>
        <input type="text" id="truckId" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø­Ù†Ø© Ø£Ùˆ Ø§Ù„Ù„ÙˆØ­Ø©">
      </div>

      <label>Ø¢Ø®Ø± Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</label>
      <input type="text" id="coordsDisplay" readonly placeholder="Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§">

      <div class="btn-row">
        <button id="btnStart">Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
        <button id="btnStop" disabled>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
      </div>

      <div class="status-box" id="statusBox">
        <span class="status-badge" id="statusBadge">Ø§Ù„Ø­Ø§Ù„Ø©: Ù…ØªÙˆÙ‚Ù</span>
        <span id="statusText">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©" Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹.</span>
        <div class="small">
          Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹Ùƒ ÙƒÙ„ Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØªØ¨Ø¹.
        </div>
      </div>

    </div>

  </div>
</div>

<script>
  // ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©
  const WEBHOOK_URL = "https://yasiralhmadiai.app.n8n.cloud/webhook/Employee-Tracking";
  const UPDATE_INTERVAL_MINUTES = 5; // ØºÙŠÙ‘Ø±Ù‡Ø§ Ø¥Ø°Ø§ Ø­Ø§Ø¨ (Ù…Ø«Ù„Ø§Ù‹ 10)
  const UPDATE_INTERVAL_MS = UPDATE_INTERVAL_MINUTES * 60 * 1000;

  let selectedType = null;     // 'driver' Ø£Ùˆ 'cleaner'
  let trackingInterval = null;
  let currentTripKey = null;   // Ø«Ø§Ø¨Øª Ù„ÙƒÙ„ Ø¬Ù„Ø³Ø© ØªØªØ¨Ø¹
  let currentStatus = "idle";

  const roleDriver = document.getElementById("roleDriver");
  const roleCleaner = document.getElementById("roleCleaner");
  const formSection = document.getElementById("formSection");
  const truckField = document.getElementById("truckField");
  const employeeIdInput = document.getElementById("employeeId");
  const employeeNameInput = document.getElementById("employeeName");
  const truckIdInput = document.getElementById("truckId");
  const coordsDisplay = document.getElementById("coordsDisplay");
  const btnStart = document.getElementById("btnStart");
  const btnStop = document.getElementById("btnStop");
  const statusBox = document.getElementById("statusBox");
  const statusBadge = document.getElementById("statusBadge");
  const statusText = document.getElementById("statusText");

  // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ±
  function selectRole(type) {
    selectedType = type;
    roleDriver.classList.toggle("selected", type === "driver");
    roleCleaner.classList.toggle("selected", type === "cleaner");
    formSection.style.display = "block";
    truckField.style.display = (type === "driver") ? "block" : "none";

    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·
    stopTracking(false);
    statusText.textContent = 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· "Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©".';
  }

  roleDriver.addEventListener("click", () => selectRole("driver"));
  roleCleaner.addEventListener("click", () => selectRole("cleaner"));

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  function updateStatus(newStatus) {
    currentStatus = newStatus;
    statusBadge.className = "status-badge";
    if (newStatus === "start") {
      statusBadge.classList.add("status-start");
      statusBadge.textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: start";
    } else if (newStatus === "running") {
      statusBadge.classList.add("status-running");
      statusBadge.textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: running";
    } else if (newStatus === "end") {
      statusBadge.classList.add("status-end");
      statusBadge.textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: end";
    } else {
      statusBadge.textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: Ù…ØªÙˆÙ‚Ù";
    }
  }

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡
  function sendLocation(statusForThisRecord) {
    if (!navigator.geolocation) {
      statusText.textContent = "âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude.toFixed(6);
        const lng = pos.coords.longitude.toFixed(6);
        coordsDisplay.value = `${lat}, ${lng}`;

        const employeeId = employeeIdInput.value.trim();
        const employeeName = employeeNameInput.value.trim();
        const truckId = (selectedType === "driver") ? (truckIdInput.value.trim() || "") : "";

        const now = new Date().toISOString();

        if (!currentTripKey) {
          // tripKey = Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù + ÙˆÙ‚Øª Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©
          currentTripKey = `${employeeId}-${now}`;
        }

        const payload = new URLSearchParams({
          employeeType: selectedType || "",
          employeeId: employeeId,
          employeeName: employeeName,
          truckId: truckId,
          latitude: lat,
          longitude: lng,
          timestamp: now,
          status: statusForThisRecord,
          tripKey: currentTripKey
        });

        fetch(WEBHOOK_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: payload.toString()
        }).then(res => {
          if (!res.ok) {
            console.error("Webhook error", res.status);
            statusText.textContent = "âš ï¸ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„ÙƒÙ† Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.";
          } else {
            if (statusForThisRecord === "start") {
              statusText.textContent = "ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¢Ù†. Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.";
            } else if (statusForThisRecord === "running") {
              statusText.textContent = `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­ (Ø§Ù„Ø­Ø§Ù„Ø© running).`;
            } else if (statusForThisRecord === "end") {
              statusText.textContent = "ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹.";
            }
          }
        }).catch(err => {
          console.error("Network error", err);
          statusText.textContent = "âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.";
        });
      },
      (err) => {
        console.error("Geolocation error", err);
        statusText.textContent = "âš ï¸ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
      },
      {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0
      }
    );
  }

  // Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹
  function startTracking() {
    if (!selectedType) {
      alert("Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¸Ù Ø£ÙˆÙ„Ø§Ù‹ (Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø¹Ø§Ù…Ù„ Ù†Ø¸Ø§ÙØ©).");
      return;
    }

    const employeeId = employeeIdInput.value.trim();
    const employeeName = employeeNameInput.value.trim();

    if (!employeeId || !employeeName) {
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù.");
      return;
    }

    if (selectedType === "driver" && !truckIdInput.value.trim()) {
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø­Ù†Ø©.");
      return;
    }

    // Ø£ÙˆÙ„ Ø³Ø¬Ù„: start
    updateStatus("start");
    sendLocation("start");

    // Ø¨Ø¹Ø¯Ù‡Ø§ Ø³Ø¬Ù„Ø§Øª running ÙƒÙ„ ÙØªØ±Ø©
    trackingInterval = setInterval(() => {
      updateStatus("running");
      sendLocation("running");
    }, UPDATE_INTERVAL_MS);

    btnStart.disabled = true;
    btnStop.disabled = false;
  }

  // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹
  function stopTracking(sendEndRecord = true) {
    if (trackingInterval) {
      clearInterval(trackingInterval);
      trackingInterval = null;
    }

    if (sendEndRecord && currentTripKey) {
      updateStatus("end");
      sendLocation("end");
    } else {
      updateStatus("idle");
      statusText.textContent = 'Ø§Ù„ØªØªØ¨Ø¹ Ù…ØªÙˆÙ‚Ù. ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©.';
    }

    btnStart.disabled = false;
    btnStop.disabled = true;
    currentTripKey = null;
  }

  btnStart.addEventListener("click", startTracking);
  btnStop.addEventListener("click", () => stopTracking(true));
</script>

</body>
</html>